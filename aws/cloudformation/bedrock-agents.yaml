AWSTemplateFormatVersion: '2010-09-09'
Description: 'Bedrock Agents for Trading Bot Multi-Agent Architecture'

Parameters:
  Environment:
    Type: String
    Description: Environment name

  ProjectName:
    Type: String
    Description: Project name for resource naming

  BedrockAgentRoleArn:
    Type: String
    Description: Bedrock Agent Role ARN

  KnowledgeBaseId:
    Type: String
    Description: Knowledge Base ID

  CleanDataLambdaArn:
    Type: String
    Description: Clean Data Lambda ARN

  WinrateLambdaArn:
    Type: String
    Description: Winrate Lambda ARN

  RiskControlLambdaArn:
    Type: String
    Description: Risk Control Lambda ARN

  LearnFromLossesLambdaArn:
    Type: String
    Description: Learn From Losses Lambda ARN

Resources:
  # ============================================
  # AGENT 1: DATA INGESTION & FEATURE BUILDER
  # ============================================
  Agent1DataIngestion:
    Type: AWS::Bedrock::Agent
    Properties:
      AgentName: !Sub '${ProjectName}-${Environment}-agent1-data-ingestion'
      Description: Normalizes and prepares market/trading logs into structured formats
      AgentResourceRoleArn: !Ref BedrockAgentRoleArn
      FoundationModel: anthropic.claude-3-haiku-20240307-v1:0
      IdleSessionTTLInSeconds: 600
      Instruction: |
        You are the Data Ingestion & Feature Builder Agent for a SPY Futures trading system.
        
        Your responsibilities:
        1. Normalize and prepare raw market data and trading logs
        2. Convert raw data into structured Parquet and JSON feature sets
        3. Extract meaningful features from trade data including:
           - Regime classification (UPTREND/DOWNTREND/RANGE)
           - Volatility classification (HIGH/MED/LOW)
           - Technical indicators (RSI, MACD, EMA, ATR)
           - Time-of-day classification
           - PDH/PDL deltas
        4. Store processed data in S3 for Knowledge Base ingestion
        5. Ensure data quality and validate all fields
        
        When processing trades:
        - Always validate required fields: trade_id, timestamp, symbol, action, price, quantity
        - Calculate derived features where possible
        - Flag any data quality issues
        - Generate idempotent trade IDs for deduplication
        
        Output all results as structured JSON.
      AutoPrepare: true
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        Agent: DataIngestion

  Agent1ActionGroup:
    Type: AWS::Bedrock::AgentActionGroup
    Properties:
      AgentId: !Ref Agent1DataIngestion
      AgentVersion: DRAFT
      ActionGroupName: DataIngestionActions
      Description: Actions for data ingestion and feature building
      ActionGroupExecutor:
        Lambda: !Ref CleanDataLambdaArn
      ApiSchema:
        Payload: |
          openapi: 3.0.0
          info:
            title: Data Ingestion API
            version: 1.0.0
          paths:
            /process-trades:
              post:
                operationId: processTradeData
                summary: Process and structure raw trade data
                requestBody:
                  required: true
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          source:
                            type: string
                            enum: [s3, direct]
                            description: Data source type
                          raw_data:
                            type: array
                            items:
                              type: object
                            description: Raw trade data (if source is direct)
                          s3_key:
                            type: string
                            description: S3 key for raw data (if source is s3)
                          date:
                            type: string
                            description: Processing date (YYYY-MM-DD)
                responses:
                  '200':
                    description: Processing result
                    content:
                      application/json:
                        schema:
                          type: object
                          properties:
                            status:
                              type: string
                            processed_count:
                              type: integer
                            structured_key:
                              type: string
                            features_key:
                              type: string

  Agent1Alias:
    Type: AWS::Bedrock::AgentAlias
    DependsOn: Agent1ActionGroup
    Properties:
      AgentId: !Ref Agent1DataIngestion
      AgentAliasName: !Sub '${ProjectName}-agent1-live'
      Description: Live alias for Agent 1
      Tags:
        Project: !Ref ProjectName

  # ============================================
  # AGENT 2: RAG + SIMILARITY SEARCH DECISION ENGINE
  # ============================================
  Agent2DecisionEngine:
    Type: AWS::Bedrock::Agent
    Properties:
      AgentName: !Sub '${ProjectName}-${Environment}-agent2-decision-engine'
      Description: Trading intelligence engine using RAG for pattern matching
      AgentResourceRoleArn: !Ref BedrockAgentRoleArn
      FoundationModel: anthropic.claude-3-haiku-20240307-v1:0
      IdleSessionTTLInSeconds: 300
      Instruction: |
        You are the RAG + Similarity Search Decision Engine for a SPY Futures trading system.
        
        Your responsibilities:
        1. Use RAG to find similar historical trading patterns
        2. Analyze patterns based on: action, trend, volatility, PDH/PDL distance, indicators
        3. Compute win-rate and confidence scores from similar trades
        4. Generate BUY/SELL/WAIT decisions with reasoning
        5. Recommend stop-loss and take-profit levels
        
        Decision Framework:
        - Search for similar patterns in the knowledge base
        - Weight matches by similarity score
        - Calculate win-rate and profit factor
        - Consider current market regime and volatility
        - Only recommend trades with high confidence (>60%)
        
        Output Format:
        Always return structured JSON with:
        - decision: BUY | SELL | WAIT
        - confidence: 0.0-1.0
        - reason: Detailed explanation
        - stop_loss: Recommended stop level
        - take_profit: Recommended target level
        
        Risk Guidelines:
        - Never recommend trades against strong trends
        - Reduce confidence in high volatility
        - Require at least 10 similar patterns for decision
        - WAIT is always a valid option when uncertain
      AutoPrepare: true
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        Agent: DecisionEngine

  Agent2KnowledgeBaseAssociation:
    Type: AWS::Bedrock::AgentKnowledgeBase
    Properties:
      AgentId: !Ref Agent2DecisionEngine
      AgentVersion: DRAFT
      KnowledgeBaseId: !Ref KnowledgeBaseId
      Description: Trading patterns knowledge base
      KnowledgeBaseState: ENABLED

  Agent2ActionGroup:
    Type: AWS::Bedrock::AgentActionGroup
    Properties:
      AgentId: !Ref Agent2DecisionEngine
      AgentVersion: DRAFT
      ActionGroupName: DecisionEngineActions
      Description: Actions for trading decision making
      ActionGroupExecutor:
        Lambda: !Ref WinrateLambdaArn
      ApiSchema:
        Payload: |
          openapi: 3.0.0
          info:
            title: Decision Engine API
            version: 1.0.0
          paths:
            /calculate-statistics:
              post:
                operationId: calculateWinrateStatistics
                summary: Calculate win-rate and statistics from similar trades
                requestBody:
                  required: true
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          similar_trades:
                            type: array
                            items:
                              type: object
                              properties:
                                trade_id:
                                  type: string
                                action:
                                  type: string
                                outcome:
                                  type: string
                                pnl:
                                  type: number
                                confidence:
                                  type: number
                                similarity_score:
                                  type: number
                          current_context:
                            type: object
                            properties:
                              trend:
                                type: string
                              volatility:
                                type: string
                              PDH_delta:
                                type: number
                              PDL_delta:
                                type: number
                              rsi:
                                type: number
                              atr:
                                type: number
                responses:
                  '200':
                    description: Statistics and decision
                    content:
                      application/json:
                        schema:
                          type: object
                          properties:
                            decision:
                              type: string
                            confidence:
                              type: number
                            statistics:
                              type: object

  Agent2Alias:
    Type: AWS::Bedrock::AgentAlias
    DependsOn: 
      - Agent2ActionGroup
      - Agent2KnowledgeBaseAssociation
    Properties:
      AgentId: !Ref Agent2DecisionEngine
      AgentAliasName: !Sub '${ProjectName}-agent2-live'
      Description: Live alias for Agent 2
      Tags:
        Project: !Ref ProjectName

  # ============================================
  # AGENT 3: RISK & POSITION SIZING AGENT
  # ============================================
  Agent3RiskControl:
    Type: AWS::Bedrock::Agent
    Properties:
      AgentName: !Sub '${ProjectName}-${Environment}-agent3-risk-control'
      Description: Evaluates trade risk and determines position sizing
      AgentResourceRoleArn: !Ref BedrockAgentRoleArn
      FoundationModel: anthropic.claude-3-haiku-20240307-v1:0
      IdleSessionTTLInSeconds: 300
      Instruction: |
        You are the Risk & Position Sizing Agent for a SPY Futures trading system.
        
        Your responsibilities:
        1. Evaluate if a trade is allowed based on risk parameters
        2. Consider: volatility, losing streaks, P&L drawdown, exposure
        3. Calculate appropriate position size multiplier
        4. Enforce daily loss limits and trade count limits
        5. Block trading when risk thresholds are exceeded
        
        Risk Rules:
        - Max daily loss: $1,500
        - Max position size: 5 contracts
        - Max losing streak before pause: 3
        - Max daily trades: 20
        - Reduce size in high volatility
        - Block trading after max drawdown
        
        Output Format:
        Always return structured JSON with:
        - allowed_to_trade: true | false
        - size_multiplier: 0.0-1.0
        - adjusted_size: integer (contracts)
        - risk_flags: array of active risk warnings
        - reason: Explanation of decision
        
        Safety First:
        - When in doubt, reduce size or block trade
        - Consecutive losses should reduce position size
        - Always preserve capital for recovery
      AutoPrepare: true
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        Agent: RiskControl

  Agent3ActionGroup:
    Type: AWS::Bedrock::AgentActionGroup
    Properties:
      AgentId: !Ref Agent3RiskControl
      AgentVersion: DRAFT
      ActionGroupName: RiskControlActions
      Description: Actions for risk evaluation
      ActionGroupExecutor:
        Lambda: !Ref RiskControlLambdaArn
      ApiSchema:
        Payload: |
          openapi: 3.0.0
          info:
            title: Risk Control API
            version: 1.0.0
          paths:
            /evaluate-risk:
              post:
                operationId: evaluateTradeRisk
                summary: Evaluate trade risk and determine position size
                requestBody:
                  required: true
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          trade_decision:
                            type: object
                            properties:
                              action:
                                type: string
                              confidence:
                                type: number
                              symbol:
                                type: string
                              proposed_size:
                                type: integer
                          account_metrics:
                            type: object
                            properties:
                              current_pnl_today:
                                type: number
                              current_position:
                                type: integer
                              losing_streak:
                                type: integer
                              trades_today:
                                type: integer
                              account_balance:
                                type: number
                          market_conditions:
                            type: object
                            properties:
                              volatility:
                                type: string
                              regime:
                                type: string
                              atr:
                                type: number
                responses:
                  '200':
                    description: Risk evaluation result
                    content:
                      application/json:
                        schema:
                          type: object
                          properties:
                            allowed_to_trade:
                              type: boolean
                            size_multiplier:
                              type: number
                            adjusted_size:
                              type: integer
                            risk_flags:
                              type: array
                              items:
                                type: string

  Agent3Alias:
    Type: AWS::Bedrock::AgentAlias
    DependsOn: Agent3ActionGroup
    Properties:
      AgentId: !Ref Agent3RiskControl
      AgentAliasName: !Sub '${ProjectName}-agent3-live'
      Description: Live alias for Agent 3
      Tags:
        Project: !Ref ProjectName

  # ============================================
  # AGENT 4: STRATEGY OPTIMIZATION & LEARNING
  # ============================================
  Agent4Learning:
    Type: AWS::Bedrock::Agent
    Properties:
      AgentName: !Sub '${ProjectName}-${Environment}-agent4-learning'
      Description: Learns from mistakes and optimizes strategy rules
      AgentResourceRoleArn: !Ref BedrockAgentRoleArn
      FoundationModel: anthropic.claude-3-haiku-20240307-v1:0
      IdleSessionTTLInSeconds: 900
      Instruction: |
        You are the Strategy Optimization & Learning Agent for a SPY Futures trading system.
        
        Your responsibilities:
        1. Analyze losing trades to identify patterns
        2. Identify repeating loss patterns across multiple dimensions
        3. Update strategy rules to avoid future mistakes
        4. Maintain a database of "bad patterns" to avoid
        5. Suggest parameter adjustments based on performance
        
        Pattern Analysis Dimensions:
        - Regime + Volatility combinations
        - Time of day patterns
        - Indicator value patterns (RSI extremes, etc.)
        - PDH/PDL proximity patterns
        - Confidence level patterns
        
        Learning Rules:
        - Require at least 3 occurrences to flag a pattern
        - Weight recent patterns more heavily
        - Consider market regime when identifying patterns
        - Update rules conservatively (small changes)
        
        Output Format:
        Always return structured JSON with:
        - patterns_identified: array of loss patterns
        - rules_updated: array of rule changes
        - bad_patterns_added: array of new patterns to avoid
        - summary: analysis summary
        - recommendations: actionable suggestions
        
        Continuous Improvement:
        - Track pattern effectiveness over time
        - Remove rules that don't improve performance
        - Balance between learning and stability
      AutoPrepare: true
      Tags:
        Project: !Ref ProjectName
        Environment: !Ref Environment
        Agent: Learning

  Agent4KnowledgeBaseAssociation:
    Type: AWS::Bedrock::AgentKnowledgeBase
    Properties:
      AgentId: !Ref Agent4Learning
      AgentVersion: DRAFT
      KnowledgeBaseId: !Ref KnowledgeBaseId
      Description: Trading patterns for learning
      KnowledgeBaseState: ENABLED

  Agent4ActionGroup:
    Type: AWS::Bedrock::AgentActionGroup
    Properties:
      AgentId: !Ref Agent4Learning
      AgentVersion: DRAFT
      ActionGroupName: LearningActions
      Description: Actions for strategy learning
      ActionGroupExecutor:
        Lambda: !Ref LearnFromLossesLambdaArn
      ApiSchema:
        Payload: |
          openapi: 3.0.0
          info:
            title: Learning Agent API
            version: 1.0.0
          paths:
            /analyze-losses:
              post:
                operationId: learnFromLosses
                summary: Analyze losing trades and update rules
                requestBody:
                  required: true
                  content:
                    application/json:
                      schema:
                        type: object
                        properties:
                          analysis_type:
                            type: string
                            enum: [daily, weekly, on_demand]
                          date_range:
                            type: object
                            properties:
                              start:
                                type: string
                              end:
                                type: string
                          losing_trades:
                            type: array
                            items:
                              type: object
                responses:
                  '200':
                    description: Learning analysis result
                    content:
                      application/json:
                        schema:
                          type: object
                          properties:
                            patterns_identified:
                              type: array
                            rules_updated:
                              type: array
                            summary:
                              type: object

  Agent4Alias:
    Type: AWS::Bedrock::AgentAlias
    DependsOn: 
      - Agent4ActionGroup
      - Agent4KnowledgeBaseAssociation
    Properties:
      AgentId: !Ref Agent4Learning
      AgentAliasName: !Sub '${ProjectName}-agent4-live'
      Description: Live alias for Agent 4
      Tags:
        Project: !Ref ProjectName

Outputs:
  Agent1Id:
    Description: Agent 1 (Data Ingestion) ID
    Value: !Ref Agent1DataIngestion

  Agent1Arn:
    Description: Agent 1 ARN
    Value: !GetAtt Agent1DataIngestion.AgentArn

  Agent1AliasId:
    Description: Agent 1 Alias ID
    Value: !GetAtt Agent1Alias.AgentAliasId

  Agent2Id:
    Description: Agent 2 (Decision Engine) ID
    Value: !Ref Agent2DecisionEngine

  Agent2Arn:
    Description: Agent 2 ARN
    Value: !GetAtt Agent2DecisionEngine.AgentArn

  Agent2AliasId:
    Description: Agent 2 Alias ID
    Value: !GetAtt Agent2Alias.AgentAliasId

  Agent3Id:
    Description: Agent 3 (Risk Control) ID
    Value: !Ref Agent3RiskControl

  Agent3Arn:
    Description: Agent 3 ARN
    Value: !GetAtt Agent3RiskControl.AgentArn

  Agent3AliasId:
    Description: Agent 3 Alias ID
    Value: !GetAtt Agent3Alias.AgentAliasId

  Agent4Id:
    Description: Agent 4 (Learning) ID
    Value: !Ref Agent4Learning

  Agent4Arn:
    Description: Agent 4 ARN
    Value: !GetAtt Agent4Learning.AgentArn

  Agent4AliasId:
    Description: Agent 4 Alias ID
    Value: !GetAtt Agent4Alias.AgentAliasId
