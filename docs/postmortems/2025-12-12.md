# Postmortem – 2025-12-12 ES Loss - Root Cause & Fixes

## Incident Summary
- **Trade cycle ID:** derived from exit order `15638` at **09:35:10 CST**
- **Symbol/contract:** ESZ5 (E-mini S&P 500 Dec 2025), 1 contract
- **Entry:** 08:53:13 CST BUY @ **6890.50** (order 14812) – created unintentionally while attempting to flatten a short
- **Exit:** 09:35:22 CST SELL @ **6856.50** (order 15638)
- **Stop/Target:** *None* (exit-order path supplied `SL=None`, `TP=None`)
- **Outcome:** Loss **-$1,700** ((6856.50 − 6890.50) × $50), no protective orders, AWS agents advised `WAIT`
- **Telemetry gap:** No `trade_cycle_id` nor trade logger entry; `mytrader.rag.pipeline_integration:log_trade_exit` warned "No current trade ID for exit logging"

## Root Causes

### 1. Exit Orders Could Open Fresh Positions
**Location**: `mytrader/execution/live_trading_manager.py:_place_exit_order()` (line 1581)

**Issue**: Exit orders were placed with `reduce_only=False` by default, allowing exit orders to accidentally open new positions if direction was wrong.

**Fix**: 
- Changed to always use `reduce_only=True` for exit orders
- Added validation to block exit orders that would open opposite positions
- Exit action now derived from current position, not signal action

### 2. AWS WAIT Advisories Were Treated as Cosmetic
**Location**: `mytrader/execution/live_trading_manager.py:_process_hybrid_signal()` (line 1486)

**Issue**: When AWS agent returned `WAIT`, code only blocked if feature flag `FF_WAIT_BLOCKING=1` was enabled. Otherwise, it applied confidence penalty but continued trading.

**Fix**:
- Removed feature flag dependency - WAIT blocking now always enforced
- Default `block_on_wait=True` in config (already was True)
- Only allows override if signal confidence exceeds `wait_override_confidence` threshold (default 0.75)
- Added structured logging when WAIT blocks trade

### 3. Stop/Target Validation Absent on Exit Path
**Location**: `mytrader/execution/live_trading_manager.py:_place_exit_order()` (line 1600)

**Issue**: Exit orders were allowed with `SL=None`, `TP=None`. When exit accidentally became entry, there were no protective brackets.

**Fix**:
- Exit orders now always use `reduce_only=True` to prevent accidental position opening
- If exit would open position, trade is blocked with structured event
- Entry guardrails now always enforced (not just when feature flag is on)

### 4. No Trade-Cycle Correlation or Learning Hooks
**Location**: `mytrader/execution/live_trading_manager.py:_place_exit_order()` (line 1603)

**Issue**: Exit orders used current cycle ID instead of entry cycle ID, making it impossible to correlate exit with entry for learning.

**Fix**:
- `_register_trade_entry()` now stores `_current_entry_cycle_id`
- Exit orders use entry's `trade_cycle_id` from `_current_entry_cycle_id` or position metadata
- Learning hooks can now match exit to entry for analysis

### 5. No Emergency Stop When Bracket Missing
**Location**: `mytrader/execution/ib_executor.py:_on_execution()` (line 542)

**Issue**: When entry order filled, there was no check to verify bracket orders (SL/TP) were successfully placed. If bracket placement failed, position was unprotected.

**Fix**:
- Added emergency stop check in `_on_execution()` callback
- After entry fill, verifies bracket orders are active
- If bracket missing, immediately places emergency stop (idempotent + retry safe)
- Logs structured event for bracket failure

## Fixes Implemented

### A. Hard Guardrails (Always Enforced)

1. **Enhanced `_validate_entry_guard()`**:
   - Always runs (not just when feature flag is on)
   - Validates bracket orientation: BUY: stop < entry < target, SELL: target < entry < stop
   - Enforces minimum distance in ticks (default 4 ticks = 1 point for ES)
   - Blocks trades with invalid SL/TP or exceeding max_loss_per_trade

2. **Enhanced `validate_bracket_prices()`**:
   - Added `min_distance_ticks` parameter (default 4)
   - Enforces minimum distance to prevent immediate fills
   - Validates bracket orientation before order placement

3. **Exit Order Safety**:
   - Always uses `reduce_only=True`
   - Validates exit won't open opposite position
   - Blocks if exit would create new position

### B. WAIT Gating

1. **Always Enforced**:
   - Removed feature flag dependency
   - Default `block_on_wait=True` (already in config)
   - Only allows override if signal confidence > `wait_override_confidence` (0.75)

2. **Structured Logging**:
   - Logs when WAIT blocks trade
   - Logs when WAIT is overridden with reason
   - Adds `AWS_WAIT` or `AWS_WAIT_OVERRIDE` reason codes

### C. Emergency Stop Protection

1. **Automatic Check**:
   - After entry fill, checks if bracket orders are active
   - If bracket missing, places emergency stop immediately
   - Idempotent: checks if stop already exists before placing

2. **Emergency Stop Method**:
   - `_place_emergency_stop()` in `ib_executor.py`
   - Uses StopLimitOrder for reliability
   - Records in order tracker with parent order ID
   - Sends Telegram alert

### D. Trade Cycle Correlation

1. **Entry Tracking**:
   - `_register_trade_entry()` stores `_current_entry_cycle_id`
   - Initialized in `__init__`
   - Cleared when trade is finalized

2. **Exit Correlation**:
   - Exit orders use entry's `trade_cycle_id` from `_current_entry_cycle_id`
   - Falls back to position metadata if available
   - Learning hooks can now match exit to entry

### E. OpenSearch Controls

1. **Default Disabled**:
   - `opensearch_enabled` defaults to `False` in config
   - Only enabled if explicitly set in environment or config

2. **Caching**:
   - KB queries cached with TTL (default 120 seconds)
   - Cache limit: 128 entries
   - Cache key based on trend/volatility/action

## Verification

### Tests Added
- `tests/test_execution_guards.py`: Tests for guardrails
  - Invalid SL/TP blocks trade
  - Bracket sanity (long/short orientation)
  - WAIT blocks trade
  - Exit resolves trade_id

### Replay Tool
- `scripts/replay_trade_from_logs.py`: Dry-run replay
  - Can replay specific trades from logs
  - Verifies guardrails would block unsafe trades
  - Example: `python scripts/replay_trade_from_logs.py --log logs/bot.log --order-id 14812`

## Follow-up / Monitoring

1. **Telemetry**: Validate that new telemetry shows single `trade_cycle_id` from signal → fill → PnL
2. **Learning**: Use recorded outcome for 2025-12-12 loss to seed Learning Agent
3. **Guardrail Replay**: Verify guardrails would block the 2025-12-12 trade in dry-run mode
4. **Emergency Stops**: Monitor logs for emergency stop placements (should be rare)

## Configuration Changes

No breaking changes. All fixes are backward compatible:
- Feature flags still work but guardrails now always enforced
- `block_on_wait=True` is default (already was)
- `opensearch_enabled=False` is default (already was)

## Files Modified

1. `mytrader/execution/live_trading_manager.py`:
   - Enhanced `_validate_entry_guard()` (always enforced, bracket orientation)
   - Enhanced `_place_exit_order()` (reduce_only=True, validation)
   - Enhanced WAIT blocking (always enforced)
   - Fixed trade_cycle_id correlation

2. `mytrader/execution/ib_executor.py`:
   - Added emergency stop check in `_on_execution()`
   - Added `_place_emergency_stop()` method

3. `mytrader/execution/order_builder.py`:
   - Enhanced `validate_bracket_prices()` (minimum distance in ticks)

4. `mytrader/execution/guards.py`:
   - No changes (already correct)

5. `mytrader/config.py`:
   - No changes (defaults already correct)

